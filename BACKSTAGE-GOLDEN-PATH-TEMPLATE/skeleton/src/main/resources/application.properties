# === Factor III: Config via Environment Variables ===
# FAIL FAST if these are missing. No "localhost" defaults allowed in Prod.
server.port=${PORT:8080}
spring.application.name={{ values.serviceName }}

# === PostgreSQL Database ===
# Database (Now using Flyway for migrations)
spring.datasource.url=${SPRING_DATASOURCE_URL}
spring.datasource.username=${POSTGRES_USER}
spring.datasource.password=${POSTGRES_PASSWORD}

# === Multi-Tenancy (Schema-per-Tenant) ===
spring.jpa.properties.hibernate.multiTenancy=SCHEMA
spring.jpa.properties.hibernate.tenant_identifier_resolver=com.hms.lib.common.tenancy.LibTenantIdentifierResolver
spring.jpa.properties.hibernate.multi_tenant_connection_provider=com.hms.servicename.tenancy.MultiTenantConnectionProvider

# Use 'update' for local dev speed, 'validate' for prod (controlled via env in prod)
# Factor XII: Flyway will handle migrations once dev creates V1__init.sql from their entities
spring.jpa.hibernate.ddl-auto=${HIBERNATE_DDL_AUTO:update}

# === ScaleKit Auth (Base) ===
scalekit.env.url=${SCALEKIT_ENVIRONMENT_URL}
scalekit.client.id=${SCALEKIT_CLIENT_ID}
scalekit.client.secret=${SCALEKIT_CLIENT_SECRET}

# 1. Resource Server (Stateless) Config - ALWAYS ON
spring.security.oauth2.resourceserver.jwt.jwk-set-uri=${scalekit.env.url}/.well-known/jwks
spring.security.oauth2.resourceserver.jwt.issuer-uri=${scalekit.env.url}

# === CONDITIONAL CONFIGURATIONS ===
{% if values.servicePattern == 'saas-backend-for-frontend' %}
# 2. OIDC Client (Stateful) Config - ONLY FOR BFF
scalekit.webhook.secret=${SCALEKIT_WEBHOOK_SECRET}

spring.security.oauth2.client.registration.scalekit.provider=scalekit
spring.security.oauth2.client.registration.scalekit.client-id=${scalekit.client.id}
spring.security.oauth2.client.registration.scalekit.client-secret=${scalekit.client.secret}
spring.security.oauth2.client.registration.scalekit.authorization-grant-type=authorization_code
spring.security.oauth2.client.registration.scalekit.redirect-uri={baseUrl}/login/oauth2/code/{registrationId}
spring.security.oauth2.client.registration.scalekit.scope=openid,profile,email,offline_access

spring.security.oauth2.client.provider.scalekit.authorization-uri=${scalekit.env.url}/authorize
spring.security.oauth2.client.provider.scalekit.token-uri=${scalekit.env.url}/token
spring.security.oauth2.client.provider.scalekit.user-info-uri=${scalekit.env.url}/userinfo
spring.security.oauth2.client.provider.scalekit.jwk-set-uri=${scalekit.env.url}/.well-known/jwks
spring.security.oauth2.client.provider.scalekit.user-name-attribute=sub
{% endif %}

{% if values.includeFlowable %}
# === Flowable (Workflow) Config ===
flowable.check-process-definitions=false
flowable.eventregistry.enabled=true
{% endif %}

{% if values.includeKafkaConsumer or values.includeKafkaProducer %}
# === Kafka Config ===
spring.kafka.bootstrap-servers=${SPRING_KAFKA_BOOTSTRAP_SERVERS}
{% if values.includeKafkaConsumer %}
spring.kafka.consumer.group-id={{ values.kafkaGroupId | default('default-projector-group') }}
spring.kafka.consumer.auto-offset-reset=earliest
{% endif %}
{% if values.includeKafkaProducer %}
# Context Propagation: Inject context into Kafka message headers
spring.kafka.producer.properties.interceptor.classes=com.hms.lib.common.kafka.ContextProducerInterceptor
{% endif %}
{% endif %}

{% if values.includeRedis %}
# === Redis (CQRS Read Model) Config ===
spring.redis.host=${SPRING_REDIS_HOST:localhost}
spring.redis.port=${SPRING_REDIS_PORT:6379}
{% endif %}

# === Factor VI: Processes (Distributed Sessions) ===
{% if values.servicePattern == 'saas-backend-for-frontend' %}
# Store sessions in Redis so we can scale the BFF horizontally
spring.session.store-type=redis
# Namespace separates sessions if multiple BFFs share one Redis
spring.session.redis.namespace=spring:session:{{ values.serviceName }}
{% endif %}

# === Factor XI: Logs ===
# Force JSON output for production consistency
logging.config=classpath:logback-spring.xml

# === Factor IX: Observability ===
management.endpoints.web.exposure.include=health,info,prometheus
management.endpoint.health.probes.enabled=true

